<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Libri</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../static/css/style.css">
    
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@19?dev",
          "react-dom/client": "https://esm.sh/react-dom@19/client?dev",
          "react-router-dom": "https://esm.sh/react-router-dom@7?dev",
          "react-router": "https://esm.sh/react-router@7?dev"
        }
      }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React from "react";
      import { createRoot } from "react-dom/client";
      import {
        BrowserRouter,
        Routes,
        Route,
        Link,
        useParams,
        Navigate
      } from "react-router-dom";

      function BookList(props){

          const [books, setBooks] = React.useState([]);
          React.useEffect(() => {
              fetch("/api/books")
              .then(response => {
                  if (!response.ok) {
                      throw new Error(`status ${response.status}`);
                  }
                  return response.json();
              })
              .then(data => setBooks(data))
              .catch(error => console.error('Error:', error));
          }, [])

          const addBook = (e) => {
              e.preventDefault();
              const data = e.target;
              const title = data['title'].value;
              const author = data['author'].value;
              const year = data['year'].value;
              const genre = data['genre'].value;
              const body = {
                  title: title,
                  author: author,
                  year: year,
                  genre: genre
              };
              fetch("/api/add_book", {
                  method: "POST",
                  headers: {
                      "Content-Type": "application/json"
                  },
                  body: JSON.stringify(body),
              })
                .then(response => response.json())
                .then(result => {
                    alert(result.message);
                    if (result.success) {
                        window.location.reload();
                    }
                })
                .catch(error => console.error('Error:', error))
          }
          return(
              <div>
                  {books.length > 0 ? (
                      <table>
                          <thead>
                          <tr>
                              <td>Codice</td>
                              <td>Titolo</td>
                          </tr>
                          </thead>
                          <tbody>
                          {books.map((book, key) => {return(
                              <tr key={key}>
                                  <td ><Link to={`/react/book/${book.code}`}>{ book.code }</Link></td>
                                  <td>{ book.title }</td>
                              </tr>);
                          })}
                          </tbody>
                      </table>
                  )
                  : (
                       <h1>Nessun libro trovato</h1>
                  )}

                  <h3>Aggiungi un libro</h3>
                  <form onSubmit={addBook}>
                      <label htmlFor="title">Titolo:</label><br/>
                      <input type="text" name="title" id="title"/><br/>
                      <label htmlFor="author">Autore:</label><br/>
                      <input type="text" name="author" id="author"/><br/>
                      <label htmlFor="year">Anno:</label><br/>
                      <input type="number" name="year" id="year"/><br/>
                      <label htmlFor="genre">Genere:</label><br/>
                      <input type="text" name="genre" id="genre"/><br/>
                      <input type="submit" value="Aggiungi"/>
                  </form>
              </div>
          );
      }

      function BookDetail(props){
          const params = useParams();
          const bookcode = params.id
          const [book, setBook] = React.useState([]);
          const [reviews, setReviews] = React.useState([]);

          React.useEffect(() => {
              fetch(`/api/book/${bookcode}`)
              .then(response => {
                  if (!response.ok) {
                      throw new Error(`status ${response.status}`);
                  }
                  return response.json();
              })
              .then(data => setBook(data))
              .catch(error => console.error('Error:', error));

              fetch(`/api/reviews/${bookcode}`)
              .then(response => {
                  if (!response.ok) {
                      throw new Error(`status ${response.status}`);
                  }
                  return response.json();
              })
              .then(data => setReviews(data))
              .catch(error => console.error('Error:', error));

          }, [])

          return(
            <div>
                <h1>{ book.title }</h1>
                <ul>
                    <li><strong>Codice: </strong>{ book.code }</li>
                    <li><strong>Autore: </strong>{ book.author }</li>
                    <li><strong>Anno di pubblicazione: </strong>{ book.year }</li>
                    <li><strong>Genere: </strong>{ book.genre }</li>
                </ul>

                <h3>Recensioni</h3>
                {reviews.length > 0 ? (
                    <div>
                        <ul>
                            {reviews.map((review, key) => {return(
                                <li key={key}><strong>{review.username}: </strong>{review.text}</li>
                            );})}
                        </ul>
                    </div>
                ) : <h3>Nessuna recensione disponibile</h3>}
            </div>
          );
      }

      function App(props){
          return (
              <BrowserRouter>
                  <Routes>
                      <Route path="/react" element={<BookList/>} />
                      <Route path="/react/book/:id" element={<BookDetail/>} />
                      <Route path="*" element={<Navigate to="/react" replace/>} />
                  </Routes>
              </BrowserRouter>
          );
      }

      const rootEl = document.getElementById("root");
      const root = createRoot(rootEl);
      root.render(React.createElement(App));
    </script>
  </body>
</html>